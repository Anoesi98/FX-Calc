import React, { useState, useEffect, useMemo } from 'react';
import { TrendingUp, Activity, DollarSign, AlertTriangle, RefreshCw, BarChart2, Shield, Crosshair } from 'lucide-react';

const ForexEliteApp = () => {
  // --- State ---
  const [accountBalance, setAccountBalance] = useState(10000);
  const [riskPercentage, setRiskPercentage] = useState(2.0);
  const [stopLoss, setStopLoss] = useState(20);
  const [selectedPair, setSelectedPair] = useState('EURUSD');
  const [exchangeRates, setExchangeRates] = useState({});
  const [loading, setLoading] = useState(true);
  const [lastUpdated, setLastUpdated] = useState(null);
  const [error, setError] = useState(null);

  // --- Constants ---
  const CURRENCY_PAIRS = [
    { pair: 'EURUSD', base: 'EUR', quote: 'USD', type: 'Major' },
    { pair: 'GBPUSD', base: 'GBP', quote: 'USD', type: 'Major' },
    { pair: 'USDJPY', base: 'USD', quote: 'JPY', type: 'Major' },
    { pair: 'USDCAD', base: 'USD', quote: 'CAD', type: 'Major' },
    { pair: 'USDCHF', base: 'USD', quote: 'CHF', type: 'Major' },
    { pair: 'AUDUSD', base: 'AUD', quote: 'USD', type: 'Major' },
    { pair: 'NZDUSD', base: 'NZD', quote: 'USD', type: 'Major' },
    { pair: 'EURGBP', base: 'EUR', quote: 'GBP', type: 'Cross' },
    { pair: 'EURJPY', base: 'EUR', quote: 'JPY', type: 'Cross' },
    { pair: 'GBPJPY', base: 'GBP', quote: 'JPY', type: 'Cross' },
    { pair: 'AUDJPY', base: 'AUD', quote: 'JPY', type: 'Cross' },
  ];

  // --- API Fetching ---
  const fetchRates = async () => {
    setLoading(true);
    setError(null);
    try {
      // Fetching based on USD to calculate pip values easier for USD accounts
      const response = await fetch('https://api.frankfurter.dev/v1/latest?base=USD');
      if (!response.ok) throw new Error('Failed to fetch rates');
      const data = await response.json();
      setExchangeRates(data.rates);
      setLastUpdated(new Date().toLocaleTimeString());
    } catch (err) {
      setError('Market data offline. Please retry.');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchRates();
  }, []);

  // --- Calculations ---
  const calculations = useMemo(() => {
    if (!exchangeRates || Object.keys(exchangeRates).length === 0) return null;

    const currentPairObj = CURRENCY_PAIRS.find(p => p.pair === selectedPair);
    if (!currentPairObj) return null;

    const { base, quote } = currentPairObj;
    
    // 1. Calculate Pip Value for Standard Lot (100,000 units)
    let pipValueStandard = 10; // Default for XXX/USD pairs (EURUSD, GBPUSD)
    let currentRate = 1;

    // Logic for Pip Value based on USD Account
    if (quote === 'USD') {
      // EUR/USD: Pip value is fixed at $10 for standard lot
      pipValueStandard = 10;
      currentRate = (1 / exchangeRates[base]) || 1; // Approx inverse for display
    } else if (base === 'USD') {
      // USD/JPY, USD/CAD: Pip value = $10 / Exchange Rate
      const rate = exchangeRates[quote];
      pipValueStandard = 10 / rate;
      currentRate = rate;
    } else {
      // Cross Pairs (e.g. EUR/GBP): Pip Value = $10 * (Quote/USD Rate)
      // Since we have USD base rates: Quote/USD is 1 / (USD/Quote)
      // Actually simpler: We need the rate of QuoteCurrency against USD.
      // If we have USD/GBP = 0.75, then GBP/USD = 1.33.
      // Pip Value = $10 * (Price of Quote Currency in USD)
      
      // Since rates are USD based (e.g. USDGBP = 0.8), price of GBP in USD is 1/0.8
      const quoteToUSD = 1 / exchangeRates[quote];
      pipValueStandard = 10 * quoteToUSD;
      
      // Approximate cross rate for display
      const baseToUSD = 1 / exchangeRates[base];
      currentRate = baseToUSD * exchangeRates[quote]; 
    }

    // 2. Risk Calculations
    const riskAmount = accountBalance * (riskPercentage / 100);
    
    // 3. Position Size (Lots)
    // Formula: RiskAmount / (StopLoss * PipValue)
    let rawLots = 0;
    if (stopLoss > 0 && pipValueStandard > 0) {
      rawLots = riskAmount / (stopLoss * pipValueStandard);
    }

    return {
      riskAmount,
      pipValueStandard,
      standardLots: rawLots,
      miniLots: rawLots * 10,
      microLots: rawLots * 100,
      units: rawLots * 100000,
      rate: currentRate
    };
  }, [accountBalance, riskPercentage, stopLoss, selectedPair, exchangeRates]);

  // --- Helper Components ---
  
  const StatCard = ({ label, value, subtext, highlight = false, icon: Icon }) => (
    <div className={`relative overflow-hidden rounded-2xl p-4 backdrop-blur-md border transition-all duration-300 group
      ${highlight 
        ? 'bg-gradient-to-br from-amber-500/20 to-amber-900/40 border-amber-500/50 shadow-[0_0_15px_rgba(245,158,11,0.3)]' 
        : 'bg-slate-800/40 border-slate-700/50 hover:border-slate-600'}`}>
      <div className="flex justify-between items-start mb-2">
        <span className="text-slate-400 text-xs font-bold uppercase tracking-wider">{label}</span>
        {Icon && <Icon className={`w-4 h-4 ${highlight ? 'text-amber-400' : 'text-slate-500'}`} />}
      </div>
      <div className={`text-2xl font-bold font-mono ${highlight ? 'text-amber-100' : 'text-white'}`}>
        {value}
      </div>
      {subtext && <div className="text-xs text-slate-400 mt-1">{subtext}</div>}
    </div>
  );

  return (
    <div className="min-h-screen bg-[#0f172a] text-white font-sans overflow-x-hidden selection:bg-amber-500/30">
      {/* --- Styles for Animations & Fonts --- */}
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Outfit', sans-serif; }
        h1, h2, .font-display { font-family: 'Bebas Neue', cursive; }
        
        .glass-panel {
          background: rgba(30, 41, 59, 0.4);
          backdrop-filter: blur(12px);
          -webkit-backdrop-filter: blur(12px);
          border: 1px solid rgba(255, 255, 255, 0.05);
          box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .gold-text-shimmer {
          background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
          background-size: 200%;
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          animation: shimmer 3s infinite linear;
        }

        @keyframes shimmer {
          0% { background-position: 0% 50%; }
          100% { background-position: 100% 50%; }
        }

        .floating-emoji {
          position: fixed;
          pointer-events: none;
          z-index: 0;
          animation: floatUp linear infinite;
          opacity: 0.05;
          font-size: 24px;
        }

        @keyframes floatUp {
          0% { transform: translateY(110vh) rotate(0deg); }
          100% { transform: translateY(-10vh) rotate(360deg); }
        }
        
        .custom-range::-webkit-slider-thumb {
          -webkit-appearance: none;
          height: 16px;
          width: 16px;
          border-radius: 50%;
          background: #f59e0b;
          cursor: pointer;
          margin-top: -6px;
          box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
        
        .custom-range::-webkit-slider-runnable-track {
          width: 100%;
          height: 4px;
          cursor: pointer;
          background: #334155;
          border-radius: 2px;
        }
      `}</style>

      {/* --- Background Effects --- */}
      <div className="fixed inset-0 overflow-hidden pointer-events-none">
        {/* Grid */}
        <div className="absolute inset-0 opacity-[0.03]" 
             style={{ backgroundImage: 'linear-gradient(#f59e0b 1px, transparent 1px), linear-gradient(90deg, #f59e0b 1px, transparent 1px)', backgroundSize: '40px 40px' }}>
        </div>
        {/* Orbs */}
        <div className="absolute -top-40 -left-40 w-96 h-96 bg-amber-600/20 rounded-full blur-[100px]" />
        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-slate-800/30 rounded-full blur-[120px]" />
        <div className="absolute -bottom-40 -right-40 w-96 h-96 bg-blue-900/20 rounded-full blur-[100px]" />
        
        {/* Floating Emojis */}
        {[...Array(15)].map((_, i) => (
          <div key={i} className="floating-emoji" style={{
            left: `${Math.random() * 100}vw`,
            animationDuration: `${15 + Math.random() * 20}s`,
            animationDelay: `-${Math.random() * 20}s`,
            fontSize: `${20 + Math.random() * 30}px`
          }}>
            {['üíµ','üìà','üìä','üí∞','üíπ','üíé','üêÇ','üêª'][Math.floor(Math.random() * 8)]}
          </div>
        ))}
      </div>

      {/* --- Main Content --- */}
      <div className="relative z-10 max-w-6xl mx-auto px-4 py-6 md:py-10">
        
        {/* Header */}
        <header className="flex justify-between items-center mb-10">
          <div>
            <h1 className="text-4xl md:text-5xl tracking-wide">
              <span className="gold-text-shimmer">FOREX</span> <span className="text-slate-100">ELITE</span>
            </h1>
            <p className="text-slate-400 text-sm md:text-base tracking-widest uppercase mt-1">Professional Risk Terminal</p>
          </div>
          <div className="hidden md:flex items-center space-x-2 text-xs text-slate-500 glass-panel px-3 py-1.5 rounded-full">
             <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
             <span>SYSTEM OPERATIONAL</span>
          </div>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-8">
          
          {/* --- LEFT COLUMN: Calculator --- */}
          <div className="lg:col-span-4 space-y-6">
            <div className="glass-panel p-6 rounded-3xl border-t border-slate-700/50">
              <div className="flex items-center space-x-2 mb-6">
                <Activity className="text-amber-500 w-5 h-5" />
                <h2 className="text-2xl text-slate-200">Position Sizing</h2>
              </div>

              {/* Account Balance */}
              <div className="mb-6 group">
                <label className="block text-slate-400 text-xs uppercase tracking-wider mb-2 font-semibold group-focus-within:text-amber-500 transition-colors">Account Balance (USD)</label>
                <div className="relative">
                  <DollarSign className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 w-5 h-5 group-focus-within:text-amber-500 transition-colors" />
                  <input 
                    type="number" 
                    value={accountBalance}
                    onChange={(e) => setAccountBalance(Number(e.target.value))}
                    className="w-full bg-slate-900/50 border border-slate-700 rounded-xl py-4 pl-12 pr-4 text-white placeholder-slate-600 focus:outline-none focus:border-amber-500/50 focus:ring-1 focus:ring-amber-500/50 transition-all font-mono text-lg"
                  />
                </div>
              </div>

              {/* Risk Percentage */}
              <div className="mb-8">
                <div className="flex justify-between text-xs uppercase tracking-wider mb-3">
                  <label className="text-slate-400 font-semibold">Risk Per Trade</label>
                  <span className="text-amber-500 font-bold">{riskPercentage}%</span>
                </div>
                <input 
                  type="range" 
                  min="0.1" 
                  max="10" 
                  step="0.1" 
                  value={riskPercentage}
                  onChange={(e) => setRiskPercentage(Number(e.target.value))}
                  className="custom-range w-full appearance-none bg-transparent"
                />
                <div className="flex justify-between text-[10px] text-slate-600 mt-2 font-mono">
                  <span>CONSERVATIVE (1%)</span>
                  <span>AGGRESSIVE (5%+)</span>
                </div>
              </div>

              {/* Pair & Stop Loss Row */}
              <div className="grid grid-cols-2 gap-4 mb-6">
                <div>
                  <label className="block text-slate-400 text-xs uppercase tracking-wider mb-2 font-semibold">Asset Pair</label>
                  <div className="relative">
                    <select 
                      value={selectedPair}
                      onChange={(e) => setSelectedPair(e.target.value)}
                      className="w-full bg-slate-900/50 border border-slate-700 rounded-xl py-3 px-4 text-white appearance-none focus:outline-none focus:border-amber-500/50 font-bold tracking-wide"
                    >
                      {CURRENCY_PAIRS.map(cp => (
                        <option key={cp.pair} value={cp.pair}>{cp.pair}</option>
                      ))}
                    </select>
                    <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500">‚ñº</div>
                  </div>
                </div>

                <div>
                  <label className="block text-slate-400 text-xs uppercase tracking-wider mb-2 font-semibold">Stop Loss (Pips)</label>
                  <div className="relative group">
                    <Shield className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 w-4 h-4 group-focus-within:text-amber-500 transition-colors" />
                    <input 
                      type="number" 
                      value={stopLoss}
                      onChange={(e) => setStopLoss(Number(e.target.value))}
                      className="w-full bg-slate-900/50 border border-slate-700 rounded-xl py-3 pl-10 pr-3 text-white focus:outline-none focus:border-amber-500/50 font-mono"
                    />
                  </div>
                </div>
              </div>
              
              {/* Manual Update & Error */}
              <div className="flex justify-between items-center mt-8 pt-4 border-t border-slate-800">
                <div className="text-[10px] text-slate-500">
                  {loading ? 'SYNCING MARKET DATA...' : `RATES UPDATED: ${lastUpdated || 'Never'}`}
                </div>
                <button 
                  onClick={fetchRates}
                  disabled={loading}
                  className="p-2 rounded-full bg-slate-800 hover:bg-slate-700 text-amber-500 transition-all hover:rotate-180 disabled:opacity-50"
                >
                  <RefreshCw className="w-4 h-4" />
                </button>
              </div>
              {error && <div className="text-red-400 text-xs mt-2 flex items-center"><AlertTriangle className="w-3 h-3 mr-1"/> {error}</div>}
            </div>

            {/* Quick Tips */}
            <div className="glass-panel p-5 rounded-2xl border-l-4 border-amber-500/50">
              <h3 className="text-amber-500 font-display text-lg mb-1">PRO TRADER TIP</h3>
              <p className="text-slate-400 text-sm leading-relaxed">
                Always set your stop loss based on market structure (support/resistance), not just a fixed number of pips. Let the chart dictate the risk, then adjust your lot size.
              </p>
            </div>
          </div>

          {/* --- RIGHT COLUMN: Results & Chart --- */}
          <div className="lg:col-span-8 space-y-6">
            
            {/* Results Grid */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <StatCard 
                label="Position Size (Standard)" 
                value={calculations ? calculations.standardLots.toFixed(2) : '0.00'} 
                subtext={`${calculations ? calculations.units.toLocaleString() : '0'} Units`}
                highlight={true}
                icon={TrendingUp}
              />
              <StatCard 
                label="Money at Risk" 
                value={calculations ? `$${calculations.riskAmount.toLocaleString(undefined, {minimumFractionDigits: 2})}` : '$0.00'} 
                subtext={`${riskPercentage}% of Balance`}
                icon={AlertTriangle}
              />
              <StatCard 
                label="Pip Value (Standard)" 
                value={calculations ? `$${calculations.pipValueStandard.toFixed(2)}` : '$0.00'} 
                subtext={`Per 1.0 Lot`}
                icon={DollarSign}
              />
            </div>
            
             {/* Secondary Lot Sizes */}
            <div className="glass-panel p-4 rounded-2xl flex justify-around items-center text-center">
                <div>
                    <div className="text-slate-500 text-[10px] uppercase tracking-wider mb-1">MINI LOTS (0.1)</div>
                    <div className="text-xl font-mono text-white">{calculations ? calculations.miniLots.toFixed(2) : '0.00'}</div>
                </div>
                <div className="w-px h-10 bg-slate-700/50"></div>
                <div>
                    <div className="text-slate-500 text-[10px] uppercase tracking-wider mb-1">MICRO LOTS (0.01)</div>
                    <div className="text-xl font-mono text-white">{calculations ? calculations.microLots.toFixed(2) : '0.00'}</div>
                </div>
                <div className="w-px h-10 bg-slate-700/50"></div>
                <div>
                    <div className="text-slate-500 text-[10px] uppercase tracking-wider mb-1">LIVE RATE</div>
                    <div className="text-xl font-mono text-amber-400">{calculations ? calculations.rate.toFixed(5) : '---'}</div>
                </div>
            </div>

            {/* TradingView Chart Embed */}
            <div className="glass-panel p-1 rounded-3xl overflow-hidden h-[450px] md:h-[500px] border-slate-700/50 shadow-2xl relative">
              <div className="absolute top-4 left-4 z-0 flex items-center space-x-2">
                 <BarChart2 className="w-4 h-4 text-slate-500" />
                 <span className="text-xs font-bold text-slate-500 tracking-widest">LIVE MARKET DATA // {selectedPair}</span>
              </div>
              <iframe
                title="TradingView Chart"
                src={`https://s.tradingview.com/widgetembed/?frameElementId=tradingview_widget&symbol=FX:${selectedPair}&interval=D&hidesidetoolbar=1&hidetoptoolbar=0&symboledit=1&saveimage=0&toolbarbg=f1f3f6&studies=[]&theme=dark&style=1&timezone=Etc%2FUTC&studies_overrides={}&overrides={}&enabled_features=[]&disabled_features=[]&locale=en&utm_source=localhost&utm_medium=widget&utm_campaign=chart&utm_term=FX:${selectedPair}`}
                className="w-full h-full rounded-2xl"
                allowTransparency="true"
                frameBorder="0"
              />
            </div>

          </div>
        </div>
        
        {/* Footer */}
        <div className="mt-12 text-center border-t border-slate-800 pt-8">
           <p className="text-slate-600 text-xs">
             MARKET DATA PROVIDED BY FRANKFURTER API ‚Ä¢ CHARTS BY TRADINGVIEW ‚Ä¢ <span className="text-amber-600">TRADE RESPONSIBLY</span>
           </p>
        </div>
      </div>
    </div>
  );
};

export default ForexEliteApp;

